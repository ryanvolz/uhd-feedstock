From 18f79a0fd0101f392346c810e84914c249a6086c Mon Sep 17 00:00:00 2001
From: Ryan Volz <rvolz@mit.edu>
Date: Thu, 31 Oct 2019 17:02:07 -0400
Subject: [PATCH 1/2] python: Do not link against python lib for building an
 extension module.

This fixes a segmentation fault when trying to use the python module on
OSX when built with conda (unsure why it doesn't arise otherwise).
Instead of linking against the python library, it is proper to not link
against the library and, for OSX builds, add linker options for
"-undefined" and "dynamic_lookup". This is precisely what the CMake
FindPython module does for linking against the Python::Module target.
---
 host/python/CMakeLists.txt | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/host/python/CMakeLists.txt b/host/python/CMakeLists.txt
index d0a6e2204..c84ce3d01 100644
--- a/host/python/CMakeLists.txt
+++ b/host/python/CMakeLists.txt
@@ -28,7 +28,11 @@ target_include_directories(pyuhd PUBLIC
     ${CMAKE_SOURCE_DIR}/lib
 )
 
-target_link_libraries(pyuhd ${BOOST_PYTHON_LIBRARY} ${Boost_LIBRARIES} ${PYTHON_LIBRARY} uhd)
+target_link_libraries(pyuhd ${BOOST_PYTHON_LIBRARY} ${Boost_LIBRARIES} uhd)
+# proper to NOT link against python library and instead add these link options on OSX
+if(APPLE)
+    target_link_options(pyuhd PRIVATE "LINKER:-undefined,dynamic_lookup")
+endif(APPLE)
 # Copy pyuhd library to the staging directory
 if(WIN32)
     set(PYUHD_LIBRARY_NAME libpyuhd.pyd)
-- 
2.20.1

